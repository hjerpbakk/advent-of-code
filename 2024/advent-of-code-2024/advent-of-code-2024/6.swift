private let example6 = """
....#.....
.........#
..........
..#.......
.......#..
..........
.#..^.....
........#.
#.........
......#...
"""

private let input6 = """
..........#..........#.#.......................................................................#...............#......#...#.......
........................................#..#..........#.........#..#..............................................................
.........#.......................................................................................................#................
..................................#.#..................................#..#.......#.....#.#............#.#........................
...#.......................................................#.........#...................#.................#......................
...............#.........#...........#................................................#..............#...........#.............#..
...................#..#..................................................................#........................................
........##..............................##................................#.....................#...#.............................
................................#...................#...........#.#...........................................................#...
......#......#...........................................#............................................#...#..#....#...............
............................#...#......#.....#.........#...#..#..............#....#...................#.........................#.
....................##.#........#.........#.............#......................#.#....#..............#........................#..#
#....................#......#..........#................................................................................#.........
..............#.............................................................#..........................#........#.....#..........#
.....................#........#......##.#.........#..........#.##.......................................#....#....................
................................................................#..#...........#.........#........................................
...............#..........#..#....#.#.#..................................#................................#..................#....
...................#....#.........................................................................................................
....#........................................................#......#......#.......................................#............#.
................................................#...#...........................................................#.................
..............#............................#.#.........................................#....#.....................................
...........#....#......#..................................................................#.....#..........#.............#.#......
...........................................#........#.#.........#.................#.....#.........................................
.............#.........#.........................#......#.....................#.#.................................................
.............#.....#................#...................................................#.........................................
..#....#............#................#...........................#..................#............#................................
#............................................................#......#..................................#...............#.......#..
.........................#...#.................................................................#..#...........................#..#
.................#.......................................#...............................#...#...#............#..........#........
......................#.........#...............#......#................................#.#....#.......#..........................
.#......##.................................#.................#...#.................#............................................#.
..#..................#.....#.#......#................................#..#...#......##....#..........#..................#..........
.................................................................................#...................................#............
..............................#..#...............................#....#.............................#.......#..................#..
..........#........#.....................................#..............#.....#..#................#........#.#..................#.
....................................#....#..........#........##...................................................................
.......#............................##.......#....#................................................................#.#............
.......................#......................................................#.................#.................................
.......#...................#..................................................................................................#...
.........#.....#................................#...............#........#.....................................#................#.
..#...........................#.....#..........#............................................#........#........#.#.................
...#.........#.............................#......#......................#.......................................#.......#.......#
.........................#.........#........#....................#..................#....#...#.................#..................
...............#.....................................................#....#....^............#.....................................
.......#.......#.....#.............#...........#...#..................................#...#.#....#.........................#......
.............#....................#..................................................#.........................#..................
......................................................##..........................................................................
.....................................#.....................................................................#............#..#....#.
#......................#....................#...#..................#....#.......................................#........#........
.#.....................................................................#...........................#....................##........
............#............#.........................#.........#.....................#..#........#...............................#..
.......#..#...........................................................#..#........#................#................#.............
..............................................................................................................#...................
..#............................#.....#.............#...............#..................................................#...........
..#........#..........................................................................#...........#.....##...................#....
..#.........#...................................#.................................................................................
...#.#......................#.......#...........#.........................................................#..........#............
.............#......#............#............................................................#......#............................
..............#......#...................................................................................................#........
..............#.#............................................................................#......##............................
...........#....................#...................#......#..............#.........................#.....#...#.............#.....
.................#......#................................................................................#...............#........
..#...........................................................................................#...................................
#.............#.......................#..#.....................................#..#.....#.....................#...................
.........#..#...#......#.......#................................#..............#.........#..........................#......#......
.....##...........#................................................................................................#..........#...
.#.........#....................................................##.............................#...#.........#....................
............#...............................#.#...............................................#...............................#...
...............................#..................#...........................#..............................................#....
.#..........#....#.............#.....#.....................#.....................#...................#.........................#..
.............................................................#................##..............#...................#...............
..........................##.........#................................................................................#...........
........#..#...........................#...................................................................#......................
..#.....#...................................................................#.....#....#..#.......#.......#.....#.....#...........
....................................#.......#....#......................................#........................#...........#....
...............#..............#.................#...............#....#....................................................#.......
....#..................#..........................................................................#.......#..........#............
..#...................................................#...............#...............................#......#................#...
.......#............#............................#.......................................#...#....................##..............
...............................#.......#................................#..............#....................#.....................
...........................#..............................................#..........................................#.#..#.......
....#........#....................#...........................................................................................#...
#..................#.....................#....................................#.#............#...................#................
....#........#...#............................#...#.......................#...............#........#....#.........................
.............................................................................................#....#...............#..#............
.........#..........#...........................................................#.#........................#..................#...
.....................................#................#.........#.#..........##......................#..#.........................
.....#..#.....................................................................#.#................................##...............
...............................#....#.#..................................................#.#.........................#........#...
#.......................................##.....#..........................#..#....................#.........#..........#..........
......#.#.............#....##...................................................................#................#....#......#....
..................#...#........................................#........................................#...#.....................
....................#...#...........##...................#..#....#.............................#......#............#..............
.........#.........................................................................#..........#...................................
......................................#...................................................................#.#.#..................#
.......#...#.....#........#..............#................#.........................#.#...........#.#.............#.......#.......
...#.................#......#...........#.............#.....................................#.....................................
.#...........................................................................................................#....................
............#..........#.......................#...........................................................................#....#.
......#....#...#.........................#......#......................##....#.......#.....................#....#.................
....................................#..........................#.......#.......#......................................#........##.
...................#..................................................................................#..............#.#..........
....#..........................#.....................#.#.........#...#......#..#....#.............................................
..................#......#................#........................................#...#........#.................................
...............................#.........#..................................................#.....................................
..................#..............................................#...............#...........#..#.................................
...........................#........................................................#........#....................................
.................#.......#.........##.............#...#....#......................#.......#.......................................
...........#...............#........................................................................#.#...........................
...........#..........#..........................#.....................#....#.........#...................##...#.........#........
.......#.............#........#...........................................#.................................................#.#...
.....................#..................................#.#......#...................#.........................#...#....#..##.....
.......#...................#.............#..#..................................................................#..................
..#........#........................#............#..#...#...........................#......................................#.#....
.............................#..#.......#.........#.....................................................................##...#....
..............##................#........................#..................................................#.....#...#...........
.............#..............#......#..............................................................#...................#...........
#...#............#...........##.............#..........................................#..........................................
..........................#.....#...................#....................#................#.......................................
.....................................................#..................................................................#...#.....
..................#.#........#....#.#.#..#...............................................#.....###..#.........................#...
.#...#.........#..........#.......................................................................#.#............#............#...
...#..............................#.............................#.#............................................#..................
#................................................#..#..........................................................#...............#.#
........................................#.............#..............#...............#.........#...#..............................
..............................#.................#..................#................#.....#.......#..........#....................
............#.......#...........#.........................................................................................#.......
#.#..............................#................#.#...................#.....................#.....................#......#......
.....#..#.......##...........................................#............................#.......................................
.......#..#..#.........#..........................#.#....#..........................#...#........................#.....#..........
"""

func day6_part1() -> Int {
    let map = createMap(from: input6)
    
    struct Position: Hashable {
        let r: Int
        let c: Int
    }
    
    var grid = map.map { Array($0) }
    let rows = grid.count
    let cols = grid[0].count
    
    var guardRow = 0
    var guardCol = 0
    var direction = (dr: -1, dc: 0)
    outer: for r in 0..<rows {
        for c in 0..<cols {
            if "^v<>".contains(grid[r][c]) {
                guardRow = r
                guardCol = c
                switch grid[r][c] {
                case "^": direction = (dr: -1, dc: 0)
                case "v": direction = (dr: 1, dc: 0)
                case "<": direction = (dr: 0, dc: -1)
                case ">": direction = (dr: 0, dc: 1)
                default: break
                }
                grid[r][c] = "."
                break outer
            }
        }
    }
    
    let deltas = [
        (dr: -1, dc: 0),
        (dr: 0, dc: 1),
        (dr: 1, dc: 0),
        (dr: 0, dc: -1)
    ]
    
    func turnRight(_ d: (Int, Int)) -> (Int, Int) {
        for i in 0..<4 {
            if deltas[i].dr == d.0 && deltas[i].dc == d.1 {
                let nd = deltas[(i+1) % 4]
                return (nd.dr, nd.dc)
            }
        }
        return d
    }
    
    var visited = Set<Position>()
    visited.insert(Position(r: guardRow, c: guardCol))
    
    while true {
        let nextR = guardRow + direction.dr
        let nextC = guardCol + direction.dc
        if nextR < 0 || nextR >= rows || nextC < 0 || nextC >= cols {
            break
        }
        
        if grid[nextR][nextC] == "#" {
            direction = turnRight(direction)
        } else {
            guardRow = nextR
            guardCol = nextC
            visited.insert(Position(r: guardRow, c: guardCol))
        }
    }
    
    return visited.count
}

func day6_part2() -> Int {
    let baseMap = createMap(from: input6)
    let rows = baseMap.count
    let cols = baseMap[0].count
    
    struct State: Hashable {
        let r: Int
        let c: Int
        let dr: Int
        let dc: Int
    }
    
    var guardStartRow = 0
    var guardStartCol = 0
    var guardStartDir = (dr: -1, dc: 0)
    outer: for r in 0..<rows {
        for c in 0..<cols {
            let ch = baseMap[r][c]
            if "^v<>".contains(ch) {
                guardStartRow = r
                guardStartCol = c
                switch ch {
                case "^": guardStartDir = (-1, 0)
                case "v": guardStartDir = (1, 0)
                case "<": guardStartDir = (0, -1)
                case ">": guardStartDir = (0, 1)
                default: break
                }
                break outer
            }
        }
    }
    
    let deltas = [
        (dr: -1, dc: 0),
        (dr: 0, dc: 1),
        (dr: 1, dc: 0),
        (dr: 0, dc: -1)
    ]
    
    func turnRight(_ d: (Int, Int)) -> (Int, Int) {
        for i in 0..<4 {
            if deltas[i].dr == d.0 && deltas[i].dc == d.1 {
                let nd = deltas[(i+1) % 4]
                return (nd.dr, nd.dc)
            }
        }
        return d
    }
    
    func runSimulation(withObstacleAt obstaclePos: (Int, Int)?) -> Bool {
        var grid = baseMap
        grid[guardStartRow][guardStartCol] = "."
        if let (or, oc) = obstaclePos {
            grid[or][oc] = "#"
        }
        
        var r = guardStartRow
        var c = guardStartCol
        var dir = guardStartDir
        
        var seenStates = Set<State>()
        while true {
            let state = State(r: r, c: c, dr: dir.0, dc: dir.1)
            if seenStates.contains(state) {
                return true
            }
            
            seenStates.insert(state)
            let nextR = r + dir.0
            let nextC = c + dir.1
            
            if nextR < 0 || nextR >= rows || nextC < 0 || nextC >= cols {
                return false
            }
            
            if grid[nextR][nextC] == "#" {
                dir = turnRight(dir)
            } else {
                r = nextR
                c = nextC
            }
        }
    }
    
    var count = 0
    for r in 0..<rows {
        for c in 0..<cols {
            if (r == guardStartRow && c == guardStartCol) { continue }
            if baseMap[r][c] == "." {
                if runSimulation(withObstacleAt: (r, c)) {
                    count += 1
                }
            }
        }
    }
    
    return count
}

private func createMap(from input: String) -> [[Character]] {
    return input
        .split(separator: "\n", omittingEmptySubsequences: false)
        .map { Array($0) }
}

